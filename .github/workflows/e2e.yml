name: Website E2E (Playwright)

on:
  push:
    branches: [ main, main-beta, epic/* ]
  pull_request:
    branches: [ main, main-beta, epic/* ]
  workflow_dispatch:
    inputs:
      updateSnapshots:
        type: boolean
        default: false
        required: false
        description: 'Create a pull request to update Playwright snapshots on the current branch'
      e2eDebug:
        type: boolean
        default: false
        required: false
        description: 'Enable tracing in artifacts for debugging E2E tests'

env:
  node-version: 24.x

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-tests:
    name: Website E2E (Playwright)
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || !inputs.updateSnapshots }}

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v6

      - name: Use Node v${{ env.node-version }}
        uses: actions/setup-node@v6
        with:
          cache: 'npm'
          node-version: ${{ env.node-version }}

      - name: Install NPM Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Website E2E Tests
        run: npx nx run esl-website-e2e:run
        env:
          E2E_DEBUG: ${{ (github.event_name == 'workflow_dispatch' && inputs.e2eDebug) && '1' || '' }}

      - name: Upload Playwright Report
        if: ${{ failure() || github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report-${{ github.run_id }}
          path: packages/esl-website-e2e/playwright-report
          retention-days: 7

  update-snapshots:
    name: Update Playwright Snapshots
    runs-on: ubuntu-latest
    needs: [e2e-tests]

    # Runs in two cases:
    # 1) Manual workflow_dispatch with updateSnapshots=true (any branch)
    # 2) Automatic follow-up if tests failed on push to main/main-beta
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.updateSnapshots) ||
      (needs.e2e-tests.result == 'failure' && github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'main-beta'))

    env:
      UPD_COMMIT_MSG: 'test(e2e): update playwright snapshots (via GitHub Actions)'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6

      - name: Use Node v${{ env.node-version }}
        uses: actions/setup-node@v6
        with:
          cache: 'npm'
          node-version: ${{ env.node-version }}

      - name: Install NPM Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Update Snapshots
        run: npx nx run esl-website-e2e:run:update
        env:
          E2E_DEBUG: ${{ (github.event_name == 'workflow_dispatch' && inputs.e2eDebug) && '1' || '' }}

      - name: Upload Playwright Report
        if: ${{ failure() }}
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report-update-${{ github.run_id }}
          path: packages/esl-website-e2e/playwright-report
          retention-days: 7

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ${{ env.UPD_COMMIT_MSG }}
          title: ${{ env.UPD_COMMIT_MSG }} for ${{ github.ref_name }}
          body: |
            This PR was automatically created to update Playwright snapshots for the `${{ github.ref_name }}` branch.
          branch: ${{ github.ref_name }}/snap-patch
          labels: automation, update-snapshots
