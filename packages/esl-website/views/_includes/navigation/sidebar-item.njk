{% macro navItem(title, collection, icon, opt = {}) %}
  {% set isDevCollection = collection == 'dev' %}
  {% set isPrimaryActive = functions.isActivePath(page.url, collection) %}

  {% set items = collections[collection] | releasedOrActive(page.url) | tree %}

  {% if items.length or isPrimaryActive %}
  <li class="sidebar-nav-item">
    <div class="sidebar-nav-item-heading {{ 'active' if isPrimaryActive }}">
      <a class="sidebar-nav-item-link icon-link" href="{{ ('/' + collection) | url }}"
         aria-label="{{ title }} home page">
        {% include "static/assets/" + icon %}
      </a>
      <esl-trigger class="sidebar-nav-item-trigger sidebar-nav-item-arrow"
                   target="::parent::next"
                   a11y-label-active="Collapse {{ title }} section"
                   a11y-label-inactive="Expand {{ title }} section"
                   {% if isPrimaryActive %}active{% endif %}>
        {{ title }}
        {% if opt.beta %}
          <sup class="badge badge-sup badge-warning">beta</sup>
        {% endif %}
        {% if opt.new %}
          <sup class="badge badge-sup badge-success">new</sup>
        {% endif %}
      </esl-trigger>
    </div>

    <esl-panel id="sidebar-{{ collection }}-menu"
               class="sidebar-nav-secondary {{ 'open' if isPrimaryActive }}"
               {% if isPrimaryActive %}data-open{% endif %}
               group="esl-nav"
               fallback-duration="400">
      {{ linkList(items, isDevCollection, opt) }}
    </esl-panel>
  </li>
  {% endif %}
{% endmacro %}

{% macro linkList(items, isDevCollection, opt = {}) %}
  <ul class="sidebar-nav-secondary-list">
    <esl-a11y-group targets="::child(li)::find(.sidebar-nav-secondary-link)"></esl-a11y-group>
    {%- set sortFields = opt.sortBy or ['order', 'name'] -%}
    {%- set sortedItems = items | sortBy(sortFields) -%}
    {%- if opt.reverse -%}{%- set sortedItems = sortedItems | reverse -%}{%- endif -%}

    {% if opt.listTail %}
      {# Separate the "see all" page (list page) from regular items #}
      {%- set seeAllItems = sortedItems | filter('data.list') -%}
      {%- set seeAllItem = seeAllItems and seeAllItems[0] -%}
      {%- set mainItems = sortedItems | exclude('data.list') -%}
      {# Ensure the current page is visible even if it falls outside the limited slice #}
      {%- set activeCandidates = mainItems | filter('url', page.url) -%}
      {%- set activeItem = activeCandidates and activeCandidates[0] -%}
      {%- set limitedItems = mainItems | limit(opt.limit or mainItems.length) -%}
      {%- set isActiveInLimited = activeItem and (limitedItems | filter('url', activeItem.url) | length) -%}
      {%- set shouldReplaceLast = activeItem and not isActiveInLimited and opt.limit and limitedItems.length >= opt.limit -%}

      {% for item in limitedItems %}
        {% set itemToRender = item %}
        {# If active item is beyond limit, replace the last displayed item with it to maintain count #}
        {% if shouldReplaceLast and loop.last %}
          {% set itemToRender = activeItem %}
        {% endif %}
        {% if itemToRender.children.length %}
          {{ subnavItem(itemToRender, isDevCollection, opt) }}
        {% else %}
          {{ link(itemToRender, isDevCollection) }}
        {% endif %}
      {% endfor %}

      {# Render the "see all" page at the end with custom label #}
      {% if seeAllItem %}
        {{ link(seeAllItem, isDevCollection, opt.seeAllLabel) }}
      {% endif %}
    {% else %}
      {% for item in sortedItems %}
        {% if item.children.length %}
          {{ subnavItem(item, isDevCollection, opt) }}
        {% else %}
          {{ link(item, isDevCollection) }}
        {% endif %}
      {% endfor %}
    {% endif %}
  </ul>
{% endmacro %}

{% macro subnavItem(item, isDevCollection, opt = {}) %}
  {% set isActive = page.url === item.url %}
  {% set hasActive = functions.isActivePath(page.url, item.url) %}
  {% set isDraft = [].concat(item.data.tags).includes('draft') %}

  <li class="sidebar-nav-secondary-item sidebar-nav-item-container"
      {% if hasActive %}aria-selected="true"{% endif %}>
    <div class="sidebar-nav-item-heading sidebar-nav-item-heading-secondary {{ 'active' if hasActive }}">
      <a class="sidebar-nav-secondary-link"
         {% if isActive %}aria-current="page"{% endif %} {% if isDraft or isDevCollection %}rel="nofollow"{% endif %}
         href="{{ item.url | url }}">
        {{ badgeByTags(item.data.tags, isDevCollection) }}
        {{ item.data.name }}
      </a>
      <esl-trigger class="sidebar-nav-item-trigger sidebar-nav-item-arrow"
                   target="::parent::next"
                   a11y-label-active="Collapse {{ item.data.name }} section"
                   a11y-label-inactive="Expand {{ item.data.name }} section"
                   {% if hasActive %}active{% endif %}>
      </esl-trigger>
    </div>

    <esl-panel class="sidebar-nav-secondary {{ 'open' if hasActive }}"
               {% if hasActive %}data-open{% endif %}
               fallback-duration="400">
      {{ linkList(item.children, isDevCollection, opt) }}
    </esl-panel>
  </li>
{% endmacro %}

{% macro link(item, isDevCollection, displayName = null) %}
  {% set isActive = page.url === item.url %}
  {% set isDraft = [].concat(item.data.tags).includes('draft') %}
  {% set itemName = displayName or item.data.name %}

  <li class="sidebar-nav-secondary-item {{ 'active' if isActive }}"
      {% if isActive %}aria-selected="true"{% endif %}>
    <a class="sidebar-nav-secondary-link"
       {% if isActive %}aria-current="page"{% endif %} {% if isDraft or isDevCollection %}rel="nofollow"{% endif %}
       href="{{ item.url | url }}">
      {{ badgeByTags(item.data.tags, isDraftCollection) }}
      {{ itemName }}
    </a>
  </li>
{% endmacro %}

{% macro badgeByTags(tags, isDevCollection) %}
  {# Tags checks ordered by priority, due to displaying single badge #}
  {% if tags.includes('deprecated') %}
    <span class="badge badge-sidebar badge-img badge-deprecated" title="Deprecated component" aria-label="Deprecated component"></span>
  {% elif tags.includes('draft') and not isDevCollection %}
    <sup class="badge badge-sidebar badge-sup badge-danger" title="Just a draft version of the page">draft</sup>
  {% elif tags.includes('updated') %}
    <sup class="badge badge-sidebar badge-sup badge-success" title="Updated" aria-label="Updated">upd</sup>
  {% elif tags.includes('new') %}
    <sup class="badge badge-sidebar badge-sup badge-success" title="New article and functionality">new</sup>
  {% endif %}
{% endmacro %}
